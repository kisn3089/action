name: Create Pull Request with Latest Tag

on:
  push:
    branches:
      - release/* # Release 브랜치에 Push될 때 실행

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Fetch all tags
        run: |
          git fetch --tags

      - name: Get the latest tag
        id: get_latest_tag
        run: |
          latest_tag=$(git tag --sort=committerdate | tail -1)
          echo "latest_tag=$latest_tag" >> $GITHUB_ENV

      - name: Create Pull Request
        env:
          LATEST_TAG: ${{ env.latest_tag }}
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          pr_data=$(jq -n --arg title "Release $LATEST_TAG" --arg head "${{ github.ref_name }}" --arg base "main" '{title: $title, head: $head, base: $base}')
          curl -s -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" -X POST -d "$pr_data" https://api.github.com/repos/${{ github.repository }}/pulls
