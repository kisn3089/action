name: Release Tag

# 실행 조건
on:
  push:
    branches:
      - main

# 실행문
jobs:
  # build 라는 Naming
  Get_Tags:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch all tags
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Fetch Tags
        run: git fetch --tags

  Create_Tag:
    needs: Get_Tags
    runs-on: ubuntu-latest
    outputs:
      newTag: ${{steps.create_new_tag.outputs.new_tag}}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Get Latest Tag
        id: get_latest_tag
        run: |
          latest_tag=$(git describe --tags --abbrev=0)
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "LATEST_TAG: $latest_tag"

      - name: Create New Tag
        id: create_new_tag
        run: |
          year=$(date +'%y')
          month=08
          minor="${year}${month}"
          echo "LATEST_TAG: ${{steps.get_latest_tag.outputs.latest_tag}}"
          echo "Minor: $minor"
          IFS='.' read -r -a parts <<< ${{steps.get_latest_tag.outputs.latest_tag}}
          major="${parts[0]}"
          latest_patch="${parts[2]}"
          echo "parts: ${parts[*]}"
          if [${{steps.get_latest_tag.outputs.latest_tag}} != "$minor"]; then
            new_patch="00"
          else
          new_patch=$(printf "%02d" $((10#$latest_patch + 1)))
          fi

          echo "New Patch: $new_patch"
          new_tag="$major.$minor.$new_patch"
          echo "New Tag: $new_tag" 
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          git tag $new_tag
          git push origin $new_tag

  create_release:
    needs: Create_Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch full history to ensure all tags are available

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.create_tag.outputs.newTag }}
          release_name: ${{ needs.create_tag.outputs.newTag }}
# month=$(date +'%m')
